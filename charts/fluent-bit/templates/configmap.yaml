apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "fluent-bit.fullname" . }}-config
  labels:
    {{- include "fluent-bit.labels" . | nindent 4 }}
data:
  fluent-bit.conf: |
    [SERVICE]
        Flush         {{ .Values.config.flush }}
        Log_Level     {{ .Values.config.logLevel }}
        Daemon        off
        Parsers_File  parsers.conf
        HTTP_Server   On
        HTTP_Listen   0.0.0.0
        HTTP_Port     2020
        # Filesystem storage for reliability
        storage.path              /var/log/fluent-bit-storage
        storage.sync              normal
        storage.checksum          off
        storage.backlog.mem_limit 50M

    [INPUT]
        Name              tail
        Tag               kube.*
        Path              {{ .Values.config.input.path }}
        Parser            {{ .Values.config.input.parser }}
        DB                /var/log/fluent-bit-state.db
        Mem_Buf_Limit     {{ .Values.config.input.memBufLimit }}
        Skip_Long_Lines   {{ if .Values.config.input.skipLongLines }}On{{ else }}Off{{ end }}
        Refresh_Interval  {{ .Values.config.input.refreshInterval }}

    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Keep_Log            On
        K8S-Logging.Parser  On
        K8S-Logging.Exclude On
        Labels              On
        Annotations         Off
        # Cache metadata to reduce API server load
        Kube_Meta_Cache_TTL 60s

    {{- if .Values.config.excludeNamespaces }}
    # Exclude specified namespaces
    [FILTER]
        Name     grep
        Match    kube.*
        Exclude  $kubernetes['namespace_name'] ^({{ join "|" .Values.config.excludeNamespaces }})$
    {{- end }}

    # Rewrite tag: system namespaces -> system.*, apps -> apps.*
    # Rules are evaluated in order; first match wins
    [FILTER]
        Name          rewrite_tag
        Match         kube.*
        Rule          $kubernetes['namespace_name'] {{ include "fluent-bit.systemNamespacesRegex" . }} system.$TAG false
        Rule          $kubernetes['namespace_name'] ^.+$ apps.$TAG false
        Emitter_Name  re_emitted

    {{- if .Values.config.extraFilters }}
    {{ .Values.config.extraFilters | nindent 4 }}
    {{- end }}

    # System logs -> yc-logging
    [OUTPUT]
        Name            yc-logging
        Match           system.*
        group_id        {{ .Values.yandexCloud.systemLogGroupId }}
        resource_type   {{ .Values.yandexCloud.systemResourceType }}
        resource_id     {{ .Values.yandexCloud.systemResourceId }}
        authorization   iam-key-file:/etc/yc/key.json
        endpoint        {{ .Values.yandexCloud.endpoint }}
        default_level   INFO
        Retry_Limit     10
        net.keepalive   On

    # App logs -> yc-logging
    [OUTPUT]
        Name            yc-logging
        Match           apps.*
        group_id        {{ .Values.yandexCloud.appsLogGroupId }}
        resource_type   {{ .Values.yandexCloud.appsResourceType }}
        resource_id     {{ .Values.yandexCloud.appsResourceId }}
        authorization   iam-key-file:/etc/yc/key.json
        endpoint        {{ .Values.yandexCloud.endpoint }}
        level_key       level
        default_level   INFO
        Retry_Limit     10
        net.keepalive   On

    {{- if .Values.config.extraOutputs }}
    {{ .Values.config.extraOutputs | nindent 4 }}
    {{- end }}

  parsers.conf: |
    [PARSER]
        Name        cri
        Format      regex
        Regex       ^(?<time>[^ ]+) (?<stream>stdout|stderr) (?<logtag>[^ ]*) (?<log>.*)$
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    [PARSER]
        Name        json
        Format      json
        Time_Key    time
        Time_Format %Y-%m-%dT%H:%M:%S.%L%z

    {{- if .Values.config.customParsers }}
    {{ .Values.config.customParsers | nindent 4 }}
    {{- end }}
